<!DOCTYPE html>
<html>
<head>
    <title>Mouse Detector AR - Camera Visible</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        /* Camera feed - now visible */
        #videoFeed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        
        /* Canvas overlay for drawing detection boxes */
        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        /* 3D viewport */
        #arViewport {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3;
            pointer-events: none;
        }
        
        /* Controls */
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 4;
            display: flex;
            gap: 10px;
        }
        
        button {
            background: #4CC3D9;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        button:hover {
            background: #36A0B8;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        /* Status panel - positioned safely */
        .status-panel {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 4;
            min-width: 200px;
            border: 2px solid #4CC3D9;
        }
        
        .status-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .status-label {
            color: #aaa;
        }
        
        .status-value {
            color: #4CC3D9;
            font-weight: bold;
        }
        
        /* Debug info */
        .debug {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 4;
        }
        
        /* Hide A-Frame UI */
        .a-enter-vr, .a-orientation-modal {
            display: none !important;
        }
    </style>
    
    <!-- Three.js for 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
</head>
<body>
    <div id="container">
        <!-- Camera feed - VISIBLE -->
        <video id="videoFeed" autoplay muted playsinline></video>
        
        <!-- Canvas for drawing detection boxes -->
        <canvas id="overlayCanvas"></canvas>
        
        <!-- 3D Viewport -->
        <div id="arViewport"></div>
        
        <!-- Controls -->
        <div class="controls">
            <button id="startBtn">‚ñ∂ Start Detection</button>
            <button id="stopBtn" disabled>‚è∏ Stop</button>
        </div>
        
        <!-- Status Panel -->
        <div class="status-panel">
            <h3 style="color: #4CC3D9; margin-bottom: 10px;">üñ±Ô∏è Mouse Detector</h3>
            <div class="status-item">
                <span class="status-label">Status:</span>
                <span id="statusText" class="status-value">Initializing...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Detected:</span>
                <span id="detectionCount" class="status-value">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">Confidence:</span>
                <span id="confidence" class="status-value">0%</span>
            </div>
            <div class="status-item">
                <span class="status-label">FPS:</span>
                <span id="fps" class="status-value">0</span>
            </div>
        </div>
        
        <!-- Debug info -->
        <div class="debug">
            <div>Debug Info:</div>
            <div id="debugText">Loading...</div>
        </div>
    </div>

    <script>
        // ================== ELEMENTS ==================
        const video = document.getElementById('videoFeed');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const ctx = overlayCanvas.getContext('2d');
        const statusText = document.getElementById('statusText');
        const detectionCount = document.getElementById('detectionCount');
        const confidence = document.getElementById('confidence');
        const fpsDisplay = document.getElementById('fps');
        const debugText = document.getElementById('debugText');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const arViewport = document.getElementById('arViewport');
        
        // ================== 3D SCENE SETUP ==================
        let scene, camera, renderer, ball;
        
        function initThreeJS() {
            // Create Three.js scene
            scene = new THREE.Scene();
            
            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0); // Transparent background
            arViewport.appendChild(renderer.domElement);
            
            // Create 3D ball
            const geometry = new THREE.SphereGeometry(0.3, 32, 32);
            const material = new THREE.MeshPhongMaterial({
                color: 0x4CC3D9,
                shininess: 100,
                transparent: true,
                opacity: 0.9
            });
            ball = new THREE.Mesh(geometry, material);
            scene.add(ball);
            
            // Add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // Start animation loop
            animate();
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            // Rotate the ball
            if (ball) {
                ball.rotation.y += 0.01;
            }
            
            renderer.render(scene, camera);
        }
        
        // ================== CAMERA & AI SETUP ==================
        let model = null;
        let isDetecting = false;
        let detectionInterval = null;
        let frameCount = 0;
        let lastTime = Date.now();
        let currentFPS = 0;
        
        async function initCamera() {
            try {
                debugText.textContent = 'Requesting camera...';
                
                // Try different constraints
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: { ideal: 'environment' },
                        frameRate: { ideal: 15 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        overlayCanvas.width = video.videoWidth;
                        overlayCanvas.height = video.videoHeight;
                        debugText.textContent = `Camera ready: ${video.videoWidth}x${video.videoHeight}`;
                        resolve();
                    };
                });
                
                statusText.textContent = 'Camera ready';
                return true;
                
            } catch (err) {
                debugText.textContent = `Camera error: ${err.message}`;
                statusText.textContent = 'Camera error';
                console.error('Camera error:', err);
                return false;
            }
        }
        
        async function loadModel() {
            try {
                debugText.textContent = 'Loading AI model...';
                statusText.textContent = 'Loading AI...';
                
                // Load COCO-SSD model
                model = await cocoSsd.load();
                
                debugText.textContent = 'AI model loaded successfully';
                statusText.textContent = 'Ready';
                console.log('Model loaded successfully');
                return true;
                
            } catch (err) {
                debugText.textContent = `Model error: ${err.message}`;
                statusText.textContent = 'Model error';
                console.error('Model loading error:', err);
                return false;
            }
        }
        
        // ================== DETECTION FUNCTIONS ==================
        async function detectObjects() {
            if (!model || !isDetecting) return;
            
            try {
                // Clear previous drawings
                ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                
                // Run detection
                const predictions = await model.detect(video);
                
                // Log all predictions for debugging
                console.log('All predictions:', predictions);
                
                // Find mice (also check for "cell phone" as sometimes mice are misclassified)
                const mousePredictions = predictions.filter(p => {
                    const isMouse = p.class === 'mouse';
                    const isCellPhone = p.class === 'cell phone' && p.score > 0.5;
                    const isRemote = p.class === 'remote' && p.score > 0.5;
                    
                    if (isMouse) {
                        console.log(`Found mouse! Confidence: ${(p.score * 100).toFixed(1)}%`);
                    }
                    
                    return isMouse || isCellPhone || isRemote;
                });
                
                // Update display
                detectionCount.textContent = mousePredictions.length;
                
                if (mousePredictions.length > 0) {
                    // Take the highest confidence detection
                    const bestDetection = mousePredictions.reduce((best, current) => 
                        current.score > best.score ? current : best
                    );
                    
                    const [x, y, width, height] = bestDetection.bbox;
                    const conf = bestDetection.score;
                    
                    // Update confidence display
                    confidence.textContent = `${Math.round(conf * 100)}%`;
                    statusText.textContent = 'Mouse detected!';
                    
                    // Draw detection box
                    ctx.strokeStyle = '#4CC3D9';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(x, y, width, height);
                    
                    // Draw label
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.fillRect(x, y - 25, 180, 25);
                    ctx.fillStyle = '#4CC3D9';
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText(`Mouse: ${Math.round(conf * 100)}%`, x + 5, y - 8);
                    
                    // Draw center point
                    const centerX = x + width / 2;
                    const centerY = y + height / 2;
                    
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, 6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Position the 3D ball
                    position3DBall(centerX, centerY, conf);
                    
                } else {
                    // No mouse detected
                    confidence.textContent = '0%';
                    statusText.textContent = 'No mouse found';
                    
                    // Hide the ball
                    if (ball) {
                        ball.position.set(0, 0, -10); // Move far away
                    }
                }
                
                // Calculate FPS
                frameCount++;
                const currentTime = Date.now();
                if (currentTime - lastTime >= 1000) {
                    currentFPS = frameCount;
                    frameCount = 0;
                    lastTime = currentTime;
                    fpsDisplay.textContent = currentFPS;
                }
                
            } catch (err) {
                console.error('Detection error:', err);
                debugText.textContent = `Detection error: ${err.message}`;
            }
        }
        
        function position3DBall(screenX, screenY, confidenceScore) {
            if (!ball) return;
            
            // Convert screen coordinates to normalized device coordinates (-1 to 1)
            const ndcX = (screenX / overlayCanvas.width) * 2 - 1;
            const ndcY = -(screenY / overlayCanvas.height) * 2 + 1;
            
            // Map to 3D space (adjust these values as needed)
            const worldX = ndcX * 3;  // Adjust multiplier for horizontal range
            const worldY = ndcY * 3;  // Adjust multiplier for vertical range
            const worldZ = -4;        // Distance from camera
            
            // Update ball position
            ball.position.set(worldX, worldY, worldZ);
            
            // Make ball visible
            ball.visible = true;
            
            // Scale based on confidence
            const scale = 0.2 + (confidenceScore * 0.8);
            ball.scale.set(scale, scale, scale);
            
            // Add color effect for high confidence
            if (confidenceScore > 0.8) {
                ball.material.color.setHex(0xFFD700); // Gold
            } else if (confidenceScore > 0.6) {
                ball.material.color.setHex(0x4CC3D9); // Blue
            } else {
                ball.material.color.setHex(0xEF2D5E); // Red
            }
            
            // Debug log
            console.log(`Ball positioned at: x=${worldX.toFixed(2)}, y=${worldY.toFixed(2)}, scale=${scale.toFixed(2)}`);
        }
        
        // ================== CONTROL FUNCTIONS ==================
        function startDetection() {
            if (isDetecting) return;
            
            isDetecting = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            statusText.textContent = 'Detecting...';
            
            // Show the ball
            if (ball) {
                ball.visible = true;
            }
            
            // Start detection loop (every 300ms = ~3 FPS)
            detectionInterval = setInterval(detectObjects, 300);
            
            debugText.textContent = 'Detection started';
        }
        
        function stopDetection() {
            isDetecting = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusText.textContent = 'Stopped';
            
            // Clear interval
            if (detectionInterval) {
                clearInterval(detectionInterval);
            }
            
            // Clear canvas
            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            
            // Hide ball
            if (ball) {
                ball.visible = false;
            }
            
            // Reset displays
            detectionCount.textContent = '0';
            confidence.textContent = '0%';
            fpsDisplay.textContent = '0';
            
            debugText.textContent = 'Detection stopped';
        }
        
        // ================== INITIALIZATION ==================
        async function initializeApp() {
            try {
                debugText.textContent = 'Initializing app...';
                
                // Initialize Three.js
                initThreeJS();
                
                // Initialize camera
                const cameraReady = await initCamera();
                if (!cameraReady) {
                    throw new Error('Camera initialization failed');
                }
                
                // Load AI model
                const modelReady = await loadModel();
                if (!modelReady) {
                    throw new Error('Model loading failed');
                }
                
                // Set up button listeners
                startBtn.addEventListener('click', startDetection);
                stopBtn.addEventListener('click', stopDetection);
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
                
                debugText.textContent = 'App initialized successfully';
                statusText.textContent = 'Ready - Click Start';
                
                // Auto-start detection after 2 seconds
                setTimeout(() => {
                    startDetection();
                }, 2000);
                
            } catch (err) {
                debugText.textContent = `Initialization failed: ${err.message}`;
                statusText.textContent = 'Error - See debug';
                console.error('Initialization error:', err);
            }
        }
        
        // ================== START THE APP ==================
        // Wait for page to load
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>